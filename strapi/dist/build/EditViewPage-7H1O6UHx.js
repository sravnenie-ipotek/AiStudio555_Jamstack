import{c5 as ce,j as e,d5 as le,u as S,ax as T,a3 as k,a5 as x,aj as f,s as B,he as v,i9 as de,b_ as H,cL as ue,dv as pe,i as ge,c6 as me,m as D,o as U,ia as he,cj as fe,fA as xe,ib as ye,ce as Ae,fB as Te,x as ke,bt as K,k as M,b as Ee,C as Ie,r as m,X as je,e as be,bf as Ce,d as Se,D as Pe,F as _e,p as ve,L as Re,by as q}from"./strapi-CQJ1aB9a.js";import{b as Oe,c as Le,d as Me}from"./apiTokens-DP1kqFE0.js";import{A as _}from"./constants-Q2dfXdfa.js";import{a as Ne,b as we,L as $e,c as De,F as Ue,A as Be}from"./TokenTypeSelect-DgVNg7oD.js";import{t as Fe,m as Ge}from"./tail-DNvMt8M-.js";import"./transferTokens-DVoMsJWG.js";import"./index-Bfy5Jobq.js";import"./index-BRVyLNfZ.js";import"./_baseMap-CWCAK5nm.js";import"./_baseEach-B3G95oE4.js";const He=ce.injectEndpoints({endpoints:t=>({getPermissions:t.query({query:()=>"/admin/content-api/permissions",transformResponse:s=>s.data}),getRoutes:t.query({query:()=>"/admin/content-api/routes",transformResponse:s=>s.data})}),overrideExisting:!1}),{useGetPermissionsQuery:qe,useGetRoutesQuery:Ve}=He,[We,Ye]=le("ApiTokenPermissionsContext"),Ke=({children:t,...s})=>e.jsx(We,{...s,children:t}),F=()=>Ye("useApiTokenPermissions"),Qe=({errors:t={},onChange:s,canEditInputs:a,isCreating:i,values:n={},apiToken:p={},onDispatch:l,setHasChangedPermissions:h})=>{const{formatMessage:c}=S(),g=({target:{value:d}})=>{h(!1),d==="full-access"&&l({type:"SELECT_ALL_ACTIONS"}),d==="read-only"&&l({type:"ON_CHANGE_READ_ONLY"})},E=[{value:"read-only",label:{id:"Settings.tokens.types.read-only",defaultMessage:"Read-only"}},{value:"full-access",label:{id:"Settings.tokens.types.full-access",defaultMessage:"Full access"}},{value:"custom",label:{id:"Settings.tokens.types.custom",defaultMessage:"Custom"}}];return e.jsx(T,{background:"neutral0",hasRadius:!0,shadow:"filterShadow",paddingTop:6,paddingBottom:6,paddingLeft:7,paddingRight:7,children:e.jsxs(k,{direction:"column",alignItems:"stretch",gap:4,children:[e.jsx(x,{variant:"delta",tag:"h2",children:c({id:"global.details",defaultMessage:"Details"})}),e.jsxs(f.Root,{gap:5,children:[e.jsx(f.Item,{col:6,xs:12,direction:"column",alignItems:"stretch",children:e.jsx(Ne,{error:t.name,value:n.name,canEditInputs:a,onChange:s})},"name"),e.jsx(f.Item,{col:6,xs:12,direction:"column",alignItems:"stretch",children:e.jsx(we,{error:t.description,value:n.description,canEditInputs:a,onChange:s})},"description"),e.jsx(f.Item,{col:6,xs:12,direction:"column",alignItems:"stretch",children:e.jsx($e,{isCreating:i,error:t.lifespan,value:n.lifespan,onChange:s,token:p})},"lifespan"),e.jsx(f.Item,{col:6,xs:12,direction:"column",alignItems:"stretch",children:e.jsx(De,{value:n.type,error:t.type,label:{id:"Settings.tokens.form.type",defaultMessage:"Token type"},onChange:d=>{g({target:{value:d}}),s({target:{name:"type",value:d}})},options:E,canEditInputs:a})},"type")]})]})})},ze=t=>{switch(t){case"POST":return{text:"success600",border:"success200",background:"success100"};case"GET":return{text:"secondary600",border:"secondary200",background:"secondary100"};case"PUT":return{text:"warning600",border:"warning200",background:"warning100"};case"DELETE":return{text:"danger600",border:"danger200",background:"danger100"};default:return{text:"neutral600",border:"neutral200",background:"neutral100"}}},Xe=B(T)`
  margin: -1px;
  border-radius: ${({theme:t})=>t.spaces[1]} 0 0 ${({theme:t})=>t.spaces[1]};
`,Je=({route:t={handler:"Nocontroller.error",method:"GET",path:"/there-is-no-path"}})=>{const{formatMessage:s}=S(),{method:a,handler:i,path:n}=t,p=n?Fe(n.split("/")):[],[l="",h=""]=i?i.split("."):[],c=ze(t.method);return e.jsxs(k,{direction:"column",alignItems:"stretch",gap:2,children:[e.jsxs(x,{variant:"delta",tag:"h3",children:[s({id:"Settings.apiTokens.createPage.BoundRoute.title",defaultMessage:"Bound route to"}),"Â ",e.jsx("span",{children:l}),e.jsxs(x,{variant:"delta",textColor:"primary600",children:[".",h]})]}),e.jsxs(k,{hasRadius:!0,background:"neutral0",borderColor:"neutral200",gap:0,children:[e.jsx(Xe,{background:c.background,borderColor:c.border,padding:2,children:e.jsx(x,{fontWeight:"bold",textColor:c.text,children:a})}),e.jsx(T,{paddingLeft:2,paddingRight:2,children:Ge(p,g=>e.jsxs(x,{textColor:g.includes(":")?"neutral600":"neutral900",children:["/",g]},g))})]})]})},Ze=()=>{const{value:{selectedAction:t,routes:s}}=F(),{formatMessage:a}=S(),i=t?.split(".")[0];return e.jsx(f.Item,{col:5,background:"neutral150",paddingTop:6,paddingBottom:6,paddingLeft:7,paddingRight:7,style:{minHeight:"100%"},direction:"column",alignItems:"stretch",children:t?e.jsx(k,{direction:"column",alignItems:"stretch",gap:2,children:i&&i in s&&s[i].map(n=>n.config.auth?.scope?.includes(t)||n.handler===t?e.jsx(Je,{route:n},n.handler):null)}):e.jsxs(k,{direction:"column",alignItems:"stretch",gap:2,children:[e.jsx(x,{variant:"delta",tag:"h3",children:a({id:"Settings.apiTokens.createPage.permissions.header.title",defaultMessage:"Advanced settings"})}),e.jsx(x,{tag:"p",textColor:"neutral600",children:a({id:"Settings.apiTokens.createPage.permissions.header.hint",defaultMessage:"Select the application's actions or the plugin's actions and click on the cog icon to display the bound route"})})]})})},V=pe`
  background: ${t=>t.theme.colors.primary100};

  #cog {
    opacity: 1;
  }
`,es=B(T)`
  display: flex;
  justify-content: space-between;
  align-items: center;

  #cog {
    opacity: 0;
    path {
      fill: ${t=>t.theme.colors.primary600};
    }
  }

  /* Show active style both on hover and when the action is selected */
  ${t=>t.$isActive&&V}
  &:hover {
    ${V}
  }
`,ss=B.div`
  flex: 1;
  align-self: center;
  border-top: 1px solid ${({theme:t})=>t.colors.neutral150};
`,ts=({controllers:t=[],label:s,orderNumber:a=0,disabled:i=!1})=>{const{value:{onChangeSelectAll:n,onChange:p,selectedActions:l,setSelectedAction:h,selectedAction:c}}=F(),{formatMessage:g}=S(),E=d=>d===c;return e.jsxs(v.Item,{value:`${s}-${a}`,children:[e.jsx(v.Header,{variant:a%2?"primary":"secondary",children:e.jsx(v.Trigger,{children:de(s)})}),e.jsx(v.Content,{children:t?.map(d=>{const R=d.actions.every(o=>l.includes(o.actionId)),P=d.actions.some(o=>l.includes(o.actionId));return e.jsxs(T,{children:[e.jsxs(k,{justifyContent:"space-between",alignItems:"center",padding:4,children:[e.jsx(T,{paddingRight:4,children:e.jsx(x,{variant:"sigma",textColor:"neutral600",children:d?.controller})}),e.jsx(ss,{}),e.jsx(T,{paddingLeft:4,children:e.jsx(H,{checked:!R&&P?"indeterminate":R,onCheckedChange:()=>{n({target:{value:[...d.actions]}})},disabled:i,children:g({id:"app.utils.select-all",defaultMessage:"Select all"})})})]}),e.jsx(f.Root,{gap:4,padding:4,children:d?.actions&&d?.actions.map(o=>e.jsx(f.Item,{col:6,direction:"column",alignItems:"stretch",children:e.jsxs(es,{$isActive:E(o.actionId),padding:2,hasRadius:!0,children:[e.jsx(H,{checked:l.includes(o.actionId),name:o.actionId,onCheckedChange:()=>{p({target:{value:o.actionId}})},disabled:i,children:e.jsx("span",{style:{overflowWrap:"anywhere"},children:o.action})}),e.jsx("button",{type:"button","data-testid":"action-cog",onClick:()=>h({target:{value:o.actionId}}),style:{display:"inline-flex",alignItems:"center"},children:e.jsx(ue,{id:"cog"})})]})},o.actionId))})]},`${s}.${d?.controller}`)})})]})},ns=({section:t=null,...s})=>e.jsx(T,{children:e.jsx(v.Root,{size:"M",children:t&&t.map((a,i)=>e.jsx(ts,{label:a.label,controllers:a.controllers,orderNumber:i,...s},a.apiId))})}),as=({...t})=>{const{value:{data:s}}=F(),{formatMessage:a}=S();return e.jsxs(f.Root,{gap:0,shadow:"filterShadow",hasRadius:!0,background:"neutral0",children:[e.jsxs(f.Item,{col:7,paddingTop:6,paddingBottom:6,paddingLeft:7,paddingRight:7,direction:"column",alignItems:"stretch",gap:6,children:[e.jsxs(k,{direction:"column",alignItems:"stretch",gap:2,children:[e.jsx(x,{variant:"delta",tag:"h2",children:a({id:"Settings.apiTokens.createPage.permissions.title",defaultMessage:"Permissions"})}),e.jsx(x,{tag:"p",textColor:"neutral600",children:a({id:"Settings.apiTokens.createPage.permissions.description",defaultMessage:"Only actions bound by a route are listed below."})})]}),s?.permissions&&e.jsx(ns,{section:s?.permissions,...t})]}),e.jsx(Ze,{})]})},is=ge().shape({name:D().max(100).required(U.required.id),type:D().oneOf(["read-only","full-access","custom"]).required(U.required.id),description:D().nullable(),lifespan:me().integer().min(0).nullable().defined(U.required.id)});function os(t,s,a,i){for(var n=a-1,p=t.length;++n<p;)if(i(t[n],s))return n;return-1}var rs=os,cs=fe,ls=ye,ds=rs,us=xe,ps=he,gs=Array.prototype,W=gs.splice;function ms(t,s,a,i){var n=i?ds:ls,p=-1,l=s.length,h=t;for(t===s&&(s=ps(s)),a&&(h=cs(t,us(a)));++p<l;)for(var c=0,g=s[p],E=a?a(g):g;(c=n(h,E,c,i))>-1;)h!==t&&W.call(h,c,1),W.call(t,c,1);return t}var hs=ms,fs=hs;function xs(t,s){return t&&t.length&&s&&s.length?fs(t,s):t}var ys=xs,As=Te,Ts=ys,ks=As(Ts),Es=ks;const Y=Ae(Es),Is=t=>{const s={allActionsIds:[],permissions:[]};return s.permissions=Object.entries(t).map(([a,i])=>({apiId:a,label:a.split("::")[1],controllers:Object.keys(i.controllers).map(n=>({controller:n,actions:n in i.controllers?i.controllers[n].map(p=>{const l=`${a}.${n}.${p}`;return a.includes("api::")&&s.allActionsIds.push(l),{action:p,actionId:l}}).flat():[]})).flat()})),s},js={data:{allActionsIds:[],permissions:[]},routes:{},selectedAction:"",selectedActions:[]},bs=(t,s)=>ke(t,a=>{switch(s.type){case"ON_CHANGE":{a.selectedActions.includes(s.value)?Y(a.selectedActions,s.value):a.selectedActions.push(s.value);break}case"SELECT_ALL_IN_PERMISSION":{s.value.every(n=>a.selectedActions.includes(n.actionId))?s.value.forEach(n=>{Y(a.selectedActions,n.actionId)}):s.value.forEach(n=>{a.selectedActions.push(n.actionId)});break}case"SELECT_ALL_ACTIONS":{a.selectedActions=[...a.data.allActionsIds];break}case"ON_CHANGE_READ_ONLY":{const i=a.data.allActionsIds.filter(n=>n.includes("find")||n.includes("findOne"));a.selectedActions=[...i];break}case"UPDATE_PERMISSIONS_LAYOUT":{a.data=Is(s.value);break}case"UPDATE_ROUTES":{a.routes={...s.value};break}case"UPDATE_PERMISSIONS":{a.selectedActions=[...s.value];break}case"SET_SELECTED_ACTION":{a.selectedAction=s.value;break}default:return a}}),Cs=()=>{const{formatMessage:t}=S(),{toggleNotification:s}=Ee(),{state:a}=Ie(),i=K(r=>r.admin_app.permissions),[n,p]=m.useState(a?.apiToken?.accessKey?{...a.apiToken}:null),[l,h]=m.useState(!!a?.apiToken?.accessKey),c=m.useRef(null),{trackUsage:g}=je(),{allowedActions:{canCreate:E,canUpdate:d,canRegenerate:R}}=be(i.settings?.["api-tokens"]),[P,o]=m.useReducer(bs,js),O=Ce("/settings/api-tokens/:id")?.params?.id,y=O==="create",{_unstableFormatAPIError:A,_unstableFormatValidationErrors:G}=Se(),Q=Pe(),j=qe(),b=Ve();m.useEffect(()=>{j.error&&s({type:"danger",message:A(j.error)})},[j.error,A,s]),m.useEffect(()=>{b.error&&s({type:"danger",message:A(b.error)})},[b.error,A,s]),m.useEffect(()=>{j.data&&o({type:"UPDATE_PERMISSIONS_LAYOUT",value:j.data})},[j.data]),m.useEffect(()=>{b.data&&o({type:"UPDATE_ROUTES",value:b.data})},[b.data]),m.useEffect(()=>{n&&(n.type==="read-only"&&o({type:"ON_CHANGE_READ_ONLY"}),n.type==="full-access"&&o({type:"SELECT_ALL_ACTIONS"}),n.type==="custom"&&o({type:"UPDATE_PERMISSIONS",value:n?.permissions}))},[n]),m.useEffect(()=>{g(y?"didAddTokenFromList":"didEditTokenFromList",{tokenType:_})},[y,g]);const{data:I,error:N,isLoading:z}=Oe(O,{skip:!O||y||!!n});m.useEffect(()=>{N&&s({type:"danger",message:A(N)})},[N,A,s]),m.useEffect(()=>{I&&(p(I),I.type==="read-only"&&o({type:"ON_CHANGE_READ_ONLY"}),I.type==="full-access"&&o({type:"SELECT_ALL_ACTIONS"}),I.type==="custom"&&o({type:"UPDATE_PERMISSIONS",value:I?.permissions}))},[I]),m.useEffect(()=>{if(l)return c.current=setTimeout(()=>{h(!1)},3e4),()=>{c.current&&(clearTimeout(c.current),c.current=null)}},[l]);const[X]=Le(),[J]=Me(),Z=async(r,C)=>{g(y?"willCreateToken":"willEditToken",{tokenType:_});try{if(y){const u=await X({...r,lifespan:r?.lifespan&&r.lifespan!=="0"?parseInt(r.lifespan.toString(),10):null,permissions:r.type==="custom"?P.selectedActions:null});if("error"in u){q(u.error)&&u.error.name==="ValidationError"?C.setErrors(G(u.error)):s({type:"danger",message:A(u.error)});return}s({type:"success",message:t({id:"notification.success.apitokencreated",defaultMessage:"API Token successfully created"})}),g("didCreateToken",{type:u.data.type,tokenType:_}),Q(`../api-tokens/${u.data.id.toString()}`,{state:{apiToken:u.data},replace:!0})}else{const u=await J({id:O,name:r.name,description:r.description,type:r.type,permissions:r.type==="custom"?P.selectedActions:null});if("error"in u){q(u.error)&&u.error.name==="ValidationError"?C.setErrors(G(u.error)):s({type:"danger",message:A(u.error)});return}s({type:"success",message:t({id:"notification.success.apitokenedited",defaultMessage:"API Token successfully edited"})}),g("didEditToken",{type:u.data.type,tokenType:_})}}catch{s({type:"danger",message:t({id:"notification.error",defaultMessage:"Something went wrong"})})}},[ee,w]=m.useState(!1),se=({target:{value:r}})=>{w(!0),o({type:"ON_CHANGE",value:r})},te=({target:{value:r}})=>{w(!0),o({type:"SELECT_ALL_IN_PERMISSION",value:r})},ne=({target:{value:r}})=>{o({type:"SET_SELECTED_ACTION",value:r})},ae=()=>{h(r=>!r),c.current&&(clearTimeout(c.current),c.current=null)},ie={...P,onChange:se,onChangeSelectAll:te,setSelectedAction:ne},$=d&&!y||E&&y,oe=!!n?.accessKey;return z?e.jsx(M.Loading,{}):e.jsx(Ke,{value:ie,children:e.jsxs(M.Main,{children:[e.jsx(M.Title,{children:t({id:"Settings.PageTitle",defaultMessage:"Settings - {name}"},{name:"API Tokens"})}),e.jsx(_e,{validationSchema:is,validateOnChange:!1,initialValues:{name:n?.name||"",description:n?.description||"",type:n?.type,lifespan:n?.lifespan},enableReinitialize:!0,onSubmit:(r,C)=>Z(r,C),children:({errors:r,handleChange:C,isSubmitting:u,values:L,setFieldValue:re})=>(ee&&L?.type!=="custom"&&re("type","custom"),e.jsxs(ve,{children:[e.jsx(Ue,{title:{id:"Settings.apiTokens.createPage.title",defaultMessage:"Create API Token"},token:n,setToken:p,toggleToken:ae,showToken:l,canEditInputs:$,canRegenerate:R,canShowToken:oe,isSubmitting:u,regenerateUrl:"/admin/api-tokens/"}),e.jsx(Re.Content,{children:e.jsxs(k,{direction:"column",alignItems:"stretch",gap:6,children:[n?.accessKey&&l&&e.jsx(e.Fragment,{children:e.jsx(Be,{token:n.accessKey,tokenType:_})}),e.jsx(Qe,{errors:r,onChange:C,canEditInputs:$,isCreating:y,values:L,apiToken:n,onDispatch:o,setHasChangedPermissions:w}),e.jsx(as,{disabled:!$||L?.type==="read-only"||L?.type==="full-access"})]})})]}))})]})})},Ds=()=>{const t=K(s=>s.admin_app.permissions.settings?.["api-tokens"].read);return e.jsx(M.Protect,{permissions:t,children:e.jsx(Cs,{})})};export{Cs as EditView,Ds as ProtectedEditView};
