<!DOCTYPE html>
<html>
<head>
    <title>Teachers DB Test - Final</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a2e; color: white; }
        .frame-container { margin: 20px 0; }
        h2 { color: #667eea; }
        .info { background: #0f0f23; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        button {
            background: #667eea; color: white; border: none;
            padding: 10px 20px; border-radius: 5px; cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #764ba2; }
        iframe { width: 100%; height: 600px; border: 2px solid #667eea; border-radius: 8px; }
        pre { background: #0f0f23; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Teachers Database Integration - Final Test</h1>

    <div class="info">
        <h2>Test Controls</h2>
        <button onclick="testAPI()">Test API Directly</button>
        <button onclick="checkIframe()">Check Iframe Content</button>
        <button onclick="forceLoad()">Force Load Teachers</button>
        <button onclick="clearConsole()">Clear Results</button>
    </div>

    <div id="results" class="info">
        <h2>Test Results</h2>
        <div id="output">Click a test button to see results...</div>
    </div>

    <div class="frame-container">
        <h2>Hebrew Teachers Page</h2>
        <iframe id="teachers-frame" src="http://localhost:3005/he/teachers.html"></iframe>
    </div>

    <script>
        const output = document.getElementById('output');

        function log(message, type = 'info') {
            const color = type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3';
            output.innerHTML += `<div style="color: ${color}; margin: 5px 0;">${message}</div>`;
        }

        function clearConsole() {
            output.innerHTML = '';
        }

        async function testAPI() {
            clearConsole();
            log('Testing API directly...');

            try {
                const response = await fetch('http://localhost:3000/api/teachers?locale=he');
                const data = await response.json();

                log(`✅ API Response: ${data.data.length} teachers found`, 'success');

                data.data.forEach((teacher, index) => {
                    log(`Teacher ${index + 1}: ${teacher.attributes.name} - ${teacher.attributes.bio}`);
                });
            } catch (error) {
                log(`❌ API Error: ${error.message}`, 'error');
            }
        }

        function checkIframe() {
            clearConsole();
            log('Checking iframe content...');

            try {
                const iframe = document.getElementById('teachers-frame');
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

                // Check for grid
                const grid = iframeDoc.querySelector('#instructors-grid, .instructor-grid-enhanced');
                if (grid) {
                    log(`✅ Found grid container`, 'success');

                    const cards = grid.querySelectorAll('.instructor-card-enhanced');
                    log(`Found ${cards.length} instructor cards`);

                    // Check first 3 cards
                    for (let i = 0; i < Math.min(3, cards.length); i++) {
                        const name = cards[i].querySelector('.instructor-name')?.textContent || 'Unknown';
                        const bio = cards[i].querySelector('.instructor-bio')?.textContent || 'No bio';
                        log(`Card ${i + 1}: ${name}`);
                        log(`Bio: ${bio.substring(0, 100)}...`);
                    }

                    // Check for Hebrew content
                    const hasHebrew = /[\u0590-\u05FF]/.test(grid.textContent);
                    if (hasHebrew) {
                        log('✅ Hebrew content detected!', 'success');
                    } else {
                        log('⚠️ No Hebrew content found', 'error');
                    }

                    // Check for static content
                    const hasStaticContent = grid.textContent.includes('Sarah Chen');
                    if (hasStaticContent) {
                        log('⚠️ Still showing static content (Sarah Chen)', 'error');
                    } else {
                        log('✅ Static content has been replaced', 'success');
                    }
                } else {
                    log('❌ Grid container not found', 'error');
                }

                // Check if loader script exists
                if (iframe.contentWindow.loadTeachersFromDB) {
                    log('✅ Teachers DB loader is available', 'success');
                } else {
                    log('❌ Teachers DB loader not found', 'error');
                }

            } catch (error) {
                log(`❌ Error checking iframe: ${error.message}`, 'error');
            }
        }

        function forceLoad() {
            clearConsole();
            log('Forcing teachers load in iframe...');

            try {
                const iframe = document.getElementById('teachers-frame');

                if (iframe.contentWindow.loadTeachersFromDB) {
                    iframe.contentWindow.loadTeachersFromDB();
                    log('✅ Called loadTeachersFromDB()', 'success');

                    // Check again after delay
                    setTimeout(() => {
                        checkIframe();
                    }, 2000);
                } else {
                    log('❌ loadTeachersFromDB function not available', 'error');
                }
            } catch (error) {
                log(`❌ Error: ${error.message}`, 'error');
            }
        }

        // Auto-check after page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('=== Initial Check ===');
                checkIframe();
            }, 3000);
        });
    </script>
</body>
</html>